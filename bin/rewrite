#! /usr/bin/env php
<?php
require_once __DIR__ . "/../includes/Engine.class.php";
require_once __DIR__ . "/../vendor/autoload.php";

function writeLog($string)
{
	global $logFile;

	if (!$logFile)
	{
		return;
	}

	file_put_contents($logFile, "[" . date("Y-m-d H:i:s") . "] " . $string . "\n", FILE_APPEND);
}

function loadEngines($engines)
{
	$instances = array();

	foreach ($engines as $engine)
	{
		writeLog("Loading engine: " . $engine);

		$file = __DIR__ . "/../engines/" . $engine . ".php";

		if (!file_exists($file))
		{
			writeLog("No such file or directory: " . $file);
			continue;
		}

		require_once $file;

		if (!class_exists($engine))
		{
			writeLog("Class not found: " . $engine);
			continue;
		}

		$config = new Pini(__DIR__ . "/../config/engines/" . $engine . ".ini");

		$instances[$engine] = new $engine($config);
	}

	return $instances;
}

$config = new Pini(__DIR__ . "/../config/config.ini");

$logFile = $config->getValue("log", "path");

$engines = loadEngines($config->getValue("engines", "engine"));

if (empty($engines))
{
	die("No engines loaded!");
}

while ($line = fgets(STDIN))
{
	$line = trim($line);

	writeLog("Input: " . $line);

	list($url, $fqdn, $ident, $method) = explode(" ", $line);

	/**
	 * @var $engine Engine
	 */
	foreach ($engines as $engineName => $engine)
	{
		$engine->url = $url;
		$engine->fqdn = $fqdn;
		$engine->ident = $ident;
		$engine->method = $method;

		writeLog("Processing using " . $engineName);

		// Process the URL using this engine (returns true on success or false if another engine should be tried)
		if ($engine->process())
		{
			$url = $engine->url;
			$fqdn = $engine->fqdn;
			$ident = $engine->ident;
			$method = $engine->method;

			writeLog("Successfully processed");
			break;
		}
	}

	$response = array
	(
		$url,
		$fqdn,
		$ident,
		$method
	);

	$line = implode(" ", $response);

	writeLog("Output: " . $line);

	echo $line;
}